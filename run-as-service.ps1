"# run-as-service.ps1 - Utrzymuje serwer ELIKSIR przy życiu\n$ErrorActionPreference = \"Stop\"\n\n$ProjectPath = $PSScriptRoot\n$LogFile = \"$ProjectPath\service.log\"\n$ErrorLogFile = \"$ProjectPath\service-error.log\"\n$MaxRestarts = 10\n$RestartDelay = 5 # sekundy\n\nfunction Write-Log {\n    param([string]$Message)\n    $timestamp = Get-Date -Format \"yyyy-MM-dd HH:mm:ss\"\n    \"[$timestamp] $Message\" | Out-File -FilePath $LogFile -Append -Encoding UTF8\n    Write-Host \"[$timestamp] $Message\"\n}\n\nfunction Write-ErrorLog {\n    param([string]$Message)\n    $timestamp = Get-Date -Format \"yyyy-MM-dd HH:mm:ss\"\n    \"[$timestamp] ERROR: $Message\" | Out-File -FilePath $ErrorLogFile -Append -Encoding UTF8\n    Write-Host \"[$timestamp] ERROR: $Message\" -ForegroundColor Red\n}\n\nWrite-Log \"=== Uruchamianie usługi ELIKSIR ===\"\nWrite-Log \"Katalog projektu: $ProjectPath\"\n\n# Sprawdź zależności\nif (-not (Test-Path \"$ProjectPath\\node_modules\")) {\n    Write-Log \"Instalowanie zależności...\"\n    try {\n        Set-Location $ProjectPath\n        npm install 2>&1 | Out-File -FilePath $LogFile -Append -Encoding UTF8\n        Write-Log \"Zależności zainstalowane.\"\n    } catch {\n        Write-ErrorLog \"Błąd instalacji: $_\"\n        exit 1\n    }\n}\n\n$restartCount = 0\nwhile ($restartCount -lt $MaxRestarts) {\n    $restartCount++\n    Write-Log \"Uruchamianie serwera (próba $restartCount/$MaxRestarts)...\"\n    \n    try {\n        Set-Location $ProjectPath\n        $process = Start-Process -FilePath \"npm\" -ArgumentList \"run dev\" -NoNewWindow -PassThru -RedirectStandardOutput \"$ProjectPath\\server-output.log\" -RedirectStandardError \"$ProjectPath\\server-error.log\"\n        Write-Log \"Serwer uruchomiony (PID: $($process.Id)).\"\n        \n        # Czekaj na zakończenie procesu\n        $process.WaitForExit()\n        \n        $exitCode = $process.ExitCode\n        Write-Log \"Serwer zakończył działanie (kod: $exitCode).\"\n        \n        if ($exitCode -eq 0) {\n            Write-Log \"Normalne zakończenie - koniec.\"\n            break\n        } else {\n            Write-ErrorLog \"Serwer zakończył się błędem. Restart za $RestartDelay sekund...\"\n            Start-Sleep -Seconds $RestartDelay\n        }\n        \n    } catch {\n        Write-ErrorLog \"Błąd uruchamiania: $_\"\n        Write-ErrorLog \"Restart za $RestartDelay sekund...\"\n        Start-Sleep -Seconds $RestartDelay\n    }\n}\n\nif ($restartCount -ge $MaxRestarts) {\n    Write-ErrorLog \"Osiągnięto maksymalną liczbę restartów ($MaxRestarts). Koniec.\"\n} else {\n    Write-Log \"Usługa zakończona.\"\n}"